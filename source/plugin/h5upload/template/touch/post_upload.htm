<!--{block return}-->
<link rel="stylesheet" type="text/css" href="source/plugin/h5upload/webuploader/webuploader.css">
<script type="text/javascript" src="source/plugin/h5upload/webuploader/webuploader.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	var fileparent = $('#filedata').parent();
	var fileparent_w = fileparent.width();
	var fileparent_h = fileparent.height();
	fileparent.css('background', 'url(source/plugin/h5upload/image/icon_photo.png) no-repeat center center');
	fileparent.html('<div id="filepick"><div style="overflow:hidden;" id="filepick_bd"></div></div>');
	$('#filepick_bd').width(fileparent_w).height(fileparent_h);
	var severurl = "{$_G[siteurl]}misc.php?mod=swfupload&operation=upload&type=image&inajax=yes&infloat=yes&simple=2&mobile=2";
	var imgUpload = new WebUploader.create({
		auto: false,
		swf: 'source/plugin/h5upload/webuploader/Uploader.swf',
		server: severurl,
		formData : {"uid":"$_G[uid]", "hash":"$swfconfig[hash]"},
		pick: "#filepick",
		threads: 1,
		accept: {
			title: "$swfconfig[imageexts][depict]",
			extensions: "$swfconfig[imageexts][ext]",
			mimeTypes: "$swfconfig[imageexts][mime]"
		},
		fileVal: 'Filedata',
		duplicate: true,
		<!--{if $setconfig['compress_open'] == 1}-->
		compress : {
			width: $setconfig['compress_width'],
			height: $setconfig['compress_height'],
			quality: $setconfig['compress_quality'],
			noCompressIfLarger: $setconfig['compress_replace'],
			compressSize: $setconfig['compress_size']
		},
		<!--{/if}-->
		<!--{if $swfconfig['limit']}-->
		fileNumLimit : $swfconfig['limit'],
		<!--{/if}-->
		<!--{if !$setconfig['compress_open'] && $swfconfig['max']}-->
		fileSingleSizeLimit : "$swfconfig[max]",
		<!--{/if}-->
	});
	imgUpload.on( 'fileQueued', function(file) {
		popup.open('<img src="' + IMGDIR + '/imageloading.gif">');
		var filename = file.name.replace(/\(/g, '[').replace(/\)/g, ']').replace(/CONTENT-TRANSFER-ENCODING/g, escape('CONTENTTRANSFERENCODING'));
		<!--{if $setconfig['upload_storage'] == 'cl_qiniuyun'}-->
			$.ajax({
				type:'POST',
				url:severurl.replace('misc.php?mod=swfupload', 'plugin.php?id=cl_qiniuyun:token&filename='+filename),
				async: false,
				dataType:'xml'
			})
			.success(function(s) {
                file.token = s.lastChild.firstChild.nodeValue;
				imgUpload.upload(file);
			})
			.error(function() {
				popup.close();
			});
		<!--{else}-->
			imgUpload.upload(file);
		<!--{/if}-->
	});
	imgUpload.on( 'uploadProgress', function(file, percentage) {

	});
	imgUpload.on( 'uploadStart', function(file) {
		<!--{if $setconfig['upload_storage'] == 'cl_qiniuyun'}-->
           imgUpload.options.server = 'http://up.qiniu.com/';
           imgUpload.options.fileVal = 'file';
           imgUpload.options.formData.token = file.token;
		<!--{/if}-->
	});
	imgUpload.on( 'uploadSuccess', function(file, response) {
		<!--{if $setconfig['upload_storage'] == 'qiniuyun'}-->
            for(key in imgUpload.options.formData){
                response[key]  = imgUpload.options.formData[key];
            }
			response['name'] = response['name'].replace(/\(/g, '[').replace(/\)/g, ']').replace(/CONTENT-TRANSFER-ENCODING/g, escape('CONTENTTRANSFERENCODING'));
			response['_raw'] = '';
			$.ajax({
				type:'POST',
				url:severurl.replace('misc.php?mod=swfupload', 'plugin.php?id=cl_qiniuyun:upload'),
				async: false,
				data:response
			})
			.success(function(s) {
				uploadSuccess(file, s);
			})
			.error(function() {
				popup.close();
			});
		<!--{else}-->
		var data = response._raw;
		uploadSuccess(file, data);
		<!--{/if}-->
	});
	imgUpload.on( 'uploadError', function(file) {
		popup.open('{lang uploadpicfailed}', 'alert');
	});
	imgUpload.on( 'uploadComplete', function(file) {
		popup.close();
	});
	imgUpload.on( 'error', function(code) {
		var err = '';
		switch (code) {
		case 'F_EXCEED_SIZE':
			err = '{lang uploadstatusmsg3}';
			break;
		case 'Q_EXCEED_NUM_LIMIT':
			err = '{lang uploadstatusmsg6}';
			break;
		case 'Q_EXCEED_SIZE_LIMIT':
			err = '{lang uploadstatusmsg3}';
			break;
		case 'Q_TYPE_DENIED':
			err = '{lang uploadstatusmsg1}';
			break;
		default:
			err = '{lang uploadpicfailed}' + code;
			break;
		}
		popup.open(err, 'alert');
		return false;
	});
	function uploadSuccess(file, data) {
		if(data == '') {
			popup.open('{lang uploadpicfailed}', 'alert');
		}
		var dataarr = data.split('|');
		if(dataarr[0] == 'DISCUZUPLOAD' && dataarr[2] == 0) {
			<!--{if $setconfig['upload_storage']}-->
			var img_url = dataarr[5];
			<!--{else}-->
			var img_url = "{$_G[setting][attachurl]}forum/"+dataarr[5];
			<!--{/if}-->
			$('#imglist').append('<li><span aid="'+dataarr[3]+'" class="del"><a href="javascript:;"><img src="{STATICURL}image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr[3]+'" title="'+dataarr[6]+'" src="'+img_url+'" /></a></span><input type="hidden" name="attachnew['+dataarr[3]+'][description]" /></li>');
		} else {
			var sizelimit = '';
			if(dataarr[7] == 'ban') {
				sizelimit = '{lang uploadpicatttypeban}';
			} else if(dataarr[7] == 'perday') {
				sizelimit = '{lang donotcross}'+Math.ceil(dataarr[8]/1024)+'K)';
			} else if(dataarr[7] > 0) {
				sizelimit = '{lang donotcross}'+Math.ceil(dataarr[7]/1024)+'K)';
			}
			popup.open(STATUSMSG[dataarr[2]] + sizelimit, 'alert');
		}
	}
	$(document).on('click', '.p_img img', function() {
		var str = $("#needmessage").val() + "[attachimg]"+$(this).attr('id').replace("aimg_", "")+"[/attachimg]";
		$("#needmessage").val(str);
		$('#needmessage').trigger("input");
	});
	<!--{if $_GET['action'] == 'edit'}-->
	if($('#imglist li').length == 0){
	<!--{loop $imgattachs['used'] $image}-->
	$('#imglist').append('<li><span aid="$image[aid]" class="del"><a href="javascript:;"><img src="{STATICURL}image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_{$image[aid]}" title="$image[filename]" src="{$_G[setting][attachurl]}forum/{$image[attachment]}" /></a></span><input type="hidden" name="attachnew[{$image[aid]}][description]" /></li>');
	<!--{/loop}-->
	}
	<!--{/if}-->
});
</script>
<!--{if $setconfig['html_mobile']}-->$setconfig['html_mobile']<!--{/if}-->
<!--{/block}-->