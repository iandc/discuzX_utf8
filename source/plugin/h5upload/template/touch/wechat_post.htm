<!--{block return}-->
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	wx.config({
		debug: false,
		appId: '{$wxconfig[appid]}',
		timestamp: '{$wxconfig[timestamp]}',
		nonceStr: '{$wxconfig[noncestr]}',
		signature: '{$wxconfig[signature]}',
		jsApiList: ['checkJsApi', 'hideMenuItems', 'chooseImage', 'uploadImage']
	});
	var fileparent = $('#filedata').parent();
	var fileparent_w = fileparent.width();
	var fileparent_h = fileparent.height();
	fileparent.css('background', 'url(source/plugin/h5upload/image/icon_photo.png) no-repeat center center');
	fileparent.html('<div style="overflow:hidden;" id="wechat_upload"></div>');
	$('#wechat_upload').width(fileparent_w).height(fileparent_h);
	var upload_url = "{$_G[siteurl]}plugin.php?id=h5upload:wechat&operation=upload&inajax=yes&infloat=yes&mobile=2";
	$(document).on("click", "#wechat_upload", function () {
		wx.chooseImage({
			count: $swfconfig['limit'],
			sizeType: ['original', 'compressed'],
			sourceType: ['album', 'camera'],
			success: function (res) {
				var localIds = res.localIds;
				if (localIds.length == 0) {
					popup.open(STATUSMSG[7], 'alert');
					return;
				}
				var i = 0;
				function wxupload() {
					wx.uploadImage({
						localId: localIds[i],
						isShowProgressTips: 1,
						success: function (res) {
							var serverId = res.serverId;
							i++;
							$.ajax({
								type: 'POST',
								url: upload_url,
								data: { "uid": "$_G[uid]", "hash": "$swfconfig[hash]", "mid": serverId }
							}).success(function (data) {
								if (data == '') {
									popup.open('{lang uploadpicfailed}', 'alert');
								}
								var dataarr = data.split('|');
								if (dataarr[0] == 'DISCUZUPLOAD' && dataarr[2] == 0) {
									$('#imglist').append('<li><span aid="' + dataarr[3] + '" class="del"><a href="javascript:;"><img src="{STATICURL}image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_' + dataarr[3] + '" title="' + dataarr[6] + '" src="{$_G[setting][attachurl]}forum/' + dataarr[5] + '" /></a></span><input type="hidden" name="attachnew[' + dataarr[3] + '][description]" /></li>');
								} else {
									var sizelimit = '';
									if (dataarr[7] == 'ban') {
										sizelimit = '{lang uploadpicatttypeban}';
									} else if (dataarr[7] == 'perday') {
										sizelimit = '{lang donotcross}' + Math.ceil(dataarr[8] / 1024) + 'K)';
									} else if (dataarr[7] > 0) {
										sizelimit = '{lang donotcross}' + Math.ceil(dataarr[7] / 1024) + 'K)';
									}
									popup.open(STATUSMSG[dataarr[2]] + sizelimit, 'alert');
								}
							}).error(function () {
								popup.open('{lang uploadpicfailed}', 'alert');
							});
							if (i < localIds.length) {
								wxupload();
							}
						}
					});
				}
				wxupload();
			}
		});
	});
	$(document).on('click', '.p_img img', function() {
		var str = $("#needmessage").val() + "[attachimg]"+$(this).attr('id').replace("aimg_", "")+"[/attachimg]";
		$("#needmessage").val(str);
		$('#needmessage').trigger("input");
	});
	<!--{if $_GET['action'] == 'edit'}-->
	if($('#imglist li').length == 0){
	<!--{loop $imgattachs['used'] $image}-->
	$('#imglist').append('<li><span aid="$image[aid]" class="del"><a href="javascript:;"><img src="{STATICURL}image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_{$image[aid]}" title="$image[filename]" src="{$_G[setting][attachurl]}forum/{$image[attachment]}" /></a></span><input type="hidden" name="attachnew[{$image[aid]}][description]" /></li>');
	<!--{/loop}-->
	}
	<!--{/if}-->
});
</script>
<!--{if $setconfig['html_mobile']}-->$setconfig['html_mobile']<!--{/if}-->
<!--{/block}-->